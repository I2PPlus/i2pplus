name: PMD

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  pmd:
    name: Run PMD and produce SARIF
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 11
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '11'

      - name: Prepare environment
        run: |
          sudo apt-get update -y
          sudo apt-get install -y unzip curl

      - name: Download PMD CLI
        # Lock to a known PMD release to avoid regressions; change PMD_VERSION if you want a newer release
        run: |
          PMD_VERSION=6.55.0
          curl -sL -o pmd.zip "https://github.com/pmd/pmd/releases/download/pmd_releases/${PMD_VERSION}/pmd-bin-${PMD_VERSION}.zip"
          unzip -q pmd.zip
          ls -la pmd-bin-*

      - name: Run PMD (generate SARIF)
        env:
          _JAVA_OPTIONS: -Xmx2g
        run: |
          PMD_DIR=$(ls -d pmd-bin-*/)
          # Use a safe, built-in ruleset instead of a custom ruleset that may contain invalid <exclude/> names.
          "${PMD_DIR}bin/run.sh" pmd \
            -d . \
            -R category/java/bestpractices.xml \
            -f sarif \
            -r pmd-report.sarif \
            --no-cache \
            --minimum-priority 2 \
            --no-progress || true

          # Fail explicitly and provide logs if SARIF wasn't produced
          if [ ! -s pmd-report.sarif ]; then
            echo "‚ùå PMD did not produce a valid SARIF report."
            ls -la
            exit 1
          fi

      - name: Show SARIF summary
        if: always()
        run: |
          echo "Report size: $(wc -c < pmd-report.sarif) bytes"
          echo "Number of violations found: $(grep -c '\"ruleId\"' pmd-report.sarif 2>/dev/null || echo '0')"

      - name: Upload SARIF (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: pmd-report
          path: pmd-report.sarif