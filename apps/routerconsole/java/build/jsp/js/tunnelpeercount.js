import{refreshElements}from"/js/refreshElements.js";const d=document,header=d.getElementById("peercount"),peers=d.getElementById("allPeers"),refreshButton=d.getElementById("refreshPage"),tunnels=d.getElementById("tunnelPeerCount"),footer=tunnels?.querySelector(".tablefooter"),REFRESH_INTERVAL=1e4,REFRESH_INTERVAL_SHORT=5e3,sorter=tunnels?new Tablesort(tunnels,{descending:!0}):null;let debugging=!1,refreshId,filterListener=!1,displayed=0,debounceTimeout;const updateTunnels=async()=>{peers?refreshElements(["#allPeers",".tablefooter"],"/tunnelpeercount",REFRESH_INTERVAL):tunnels&&refreshElements("#tunnelPeerCount","/tunnelpeercount",REFRESH_INTERVAL_SHORT),checkForCachedFilter(),applyQueryParamsFilter()},initRefresh=()=>{updateTunnels()};function initFilter(){const table=tunnels;if(!d.getElementById("filterInput")){var tnlFilter=d.createElement("span");tnlFilter.id="tnlfilter";const filterInput=d.createElement("input");filterInput.type="text",filterInput.id="filterInput",filterInput.value=localStorage.getItem("filterValue")||"",tnlFilter.appendChild(filterInput);var clearFilter=d.createElement("button");clearFilter.textContent="X",clearFilter.addEventListener("click",()=>{filterInput.value="",localStorage.removeItem("filterValue"),history.replaceState({},d.title,window.location.pathname),table.querySelectorAll(".lazy").forEach(row=>row.style.display="table-row"),applyFilter(""),displayPeerCount()}),tnlFilter.appendChild(clearFilter),header.appendChild(tnlFilter),applyFilter(filterInput.value)}}function checkForCachedFilter(){var filterInput=d.getElementById("filterInput");filterInput&&(filterInput.value=localStorage.getItem("filterValue")||"",filterInput.value)&&applyFilter(filterInput.value),displayPeerCount()}function applyFilter(filterValue){var rows=peers.querySelectorAll(".lazy"),filterParts=(displayed=0,filterValue.split("="));const filterKey=filterParts[0].trim(),filterTerm=(1<filterParts.length?filterParts[1]:filterValue).trim();rows.forEach(row=>{var country=row.querySelector("td:first-child span.cc")?.textContent||"",routerId=row.querySelector("td:nth-child(2) a")?.textContent||"",version=row.querySelector("td:nth-child(3) a")?.textContent||"",bwTier=row.querySelector("td:nth-child(4) a")?.textContent||"",ipAddress=row.querySelector("td:nth-child(5) .ipaddress")?.textContent||"",rlookup=row.querySelector("td:nth-child(6) .rlookup")?.textContent||"";let shouldDisplay=!1;switch(filterKey){case"tier":shouldDisplay=bwTier.includes(filterTerm);break;case"cc":case"country":shouldDisplay=country.includes(filterTerm.toUpperCase());break;case"hash":case"id":shouldDisplay=routerId.includes(filterTerm);break;case"hostname":case"host":case"h":shouldDisplay=rlookup.includes(filterTerm);break;case"ip":shouldDisplay=ipAddress.includes(filterTerm);break;case"v":case"version":shouldDisplay=version.includes(filterTerm);break;default:shouldDisplay=country.includes(filterTerm)||routerId.includes(filterTerm)||version.includes(filterTerm)||bwTier.includes(filterTerm)||ipAddress.includes(filterTerm)||rlookup&&rlookup.includes(filterTerm)}row.style.display=shouldDisplay?"table-row":"none",shouldDisplay&&displayed++}),""===filterValue?displayPeerCount():(clearTimeout(debounceTimeout),debounceTimeout=setTimeout(()=>{displayPeerCount()},500))}function displayPeerCount(){var navTab,totalCount,filterCount,filterInput;0<=parseInt(displayed,10)&&(navTab=d.querySelector(".confignav .tab2"),totalCount=(tunnels.querySelector("tfoot .tablefooter td:first-child")?.textContent||"").match(/\d+/)?.[0]||0,filterCount=d.querySelector("#filterCount")||d.createElement("span"),(filterInput=d.getElementById("filterInput"))?.value,filterInput?(filterCount.id="filterCount",0<displayed?(filterCount.textContent=` (${displayed})`,navTab.querySelector("#filterCount")||navTab.appendChild(filterCount),d.body.classList.remove("noresults")):(filterCount.textContent="",navTab.querySelector("#filterCount")&&navTab.removeChild(filterCount),d.body.classList.add("noresults"))):filterCount.textContent=` (${totalCount})`)}function addFilterListener(){var filterInput=d.getElementById("filterInput");filterInput&&(filterInput.addEventListener("input",event=>{""===(event=event.target.value)?localStorage.removeItem("filterValue"):localStorage.setItem("filterValue",event),applyFilter(event),updateURLWithFilter(event)}),filterListener=!0)}function applyQueryParamsFilter(){var filterParam=(urlParams=new URLSearchParams(window.location.search)).get("filter"),urlParams=urlParams.get("type");if(filterParam){var filterInput=d.getElementById("filterInput");filterInput&&(urlParams&&["tier","cc","country","hash","id","h","hostname","host","ip","v","version"].includes(urlParams)?(filterInput.value=urlParams+"="+filterParam,localStorage.setItem("filterValue",urlParams+"="+filterParam),applyFilter(urlParams+"="+filterParam)):(filterInput.value=filterParam,localStorage.setItem("filterValue",filterParam),applyFilter(filterParam)))}else if(urlParams=localStorage.getItem("filterValue")||""){const filterInput=d.getElementById("filterInput");filterInput&&(applyFilter(filterInput.value=urlParams),updateURLWithFilter(urlParams))}}function updateURLWithFilter(filterValue){var filterKey,filterParts,urlParams=new URLSearchParams(window.location.search);filterValue?(filterKey=(filterParts=filterValue.split("="))[0].trim(),filterParts=(1<filterParts.length?filterParts[1]:filterValue).trim(),["tier","cc","country","hash","id","h","hostname","host","ip","v","version"].includes(filterKey)?(urlParams.set("filter",filterParts),urlParams.set("type",filterKey)):(urlParams.set("filter",filterValue),urlParams.delete("type"))):(urlParams.delete("filter"),urlParams.delete("type")),history.replaceState({},d.title,""+window.location.pathname+(urlParams.toString()?"?"+urlParams.toString():""))}d.addEventListener("DOMContentLoaded",()=>{progressx.hide(),initRefresh(),initFilter(),filterListener||addFilterListener(),refreshButton?.addEventListener("click",async()=>{await updateTunnels()}),refreshButton?.addEventListener("mouseenter",()=>{refreshButton?.removeAttribute("href")}),tunnels?.addEventListener("beforeSort",()=>{progressx.show(theme)}),tunnels?.addEventListener("afterSort",()=>{progressx.hide(),checkForCachedFilter()}),document.addEventListener("refreshComplete",()=>{sorter?.refresh()})});