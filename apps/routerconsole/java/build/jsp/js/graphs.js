import{onVisible,onHidden}from"/js/onVisible.js";(()=>{const d=document,$=id=>d.getElementById(id),query=s=>d.querySelector(s),form=$("gform"),allgraphs=($("graphConfigs"),$("allgraphs")),h3=$("graphdisplay"),sb=$("sidebar");let graphsTimerId,longestLoadTime=500,lastRefreshTime=0;function applyFilter(input){const text=input.value.trim().toLowerCase(),entry={bandwidth:{include:["bw","bps","bandwidth","combined"],exclude:["jobwait"]},count:{include:["count","participatingtunnels"],exclude:[]},ssu:{include:["udp","ssu"],exclude:[]},tco:{include:["ntcp","tcp"],exclude:[]},transit:{include:["participating","transit"],exclude:[]}}[text];d.querySelectorAll(".graphContainer").forEach(container=>{var excludesAny,img=container.querySelector("img");if(img){const alt=(img.alt||"").toLowerCase();text?entry?(img=entry.include.some(inc=>alt.includes(inc)),excludesAny=entry.exclude.some(exc=>alt.includes(exc)),container.style.display=(img=img&&!excludesAny)?"":"none",img&&container.classList.remove("loading")):(excludesAny=alt.includes(text),container.style.display=excludesAny?"":"none",excludesAny&&container.classList.remove("loading")):(container.style.display="",container.classList.remove("loading"))}else container.style.display="none"}),localStorage.setItem("graphsFilter",input.value.trim())}let imgObservers=[];function initializeObservers(target,debouncedFunc){imgObservers.forEach(obs=>obs.disconnect()),imgObservers.length=0,target&&new MutationObserver(debouncedFunc).observe(target,{childList:!0,subtree:!0}),d.querySelectorAll(".graphContainer").forEach(container=>{if("none"!==container.style.display&&(container=container.querySelector("img"))){const io=new IntersectionObserver(entries=>{entries.forEach(entry=>{entry.isIntersecting&&(debouncedFunc(),io.unobserve(entry.target))})},{rootMargin:"200px 0px 200px 0px"});io.observe(container),imgObservers.push(io)}})}function ensureDimensions(){!async function(){var styleElem=query("style#gwrap");if(!styleElem)return!1;if(!(firstImg=query(".statimage")))return!1;try{await firstImg.decode()}catch(error){return!1}var w=firstImg.naturalWidth,firstImg=firstImg.naturalHeight;return!(w<=40||firstImg<=20||(styleElem.innerText!==(w=`.graphContainer { width: ${w+4}px; height: ${firstImg+4}px; }`)&&(styleElem.innerText=w),0))}()&&d.querySelector(".statimage")&&setTimeout(ensureDimensions,200)}async function updateGraphs(input,debouncedFunc){if(!("undefined"==typeof graphRefreshInterval||graphRefreshInterval<=0)){progressx.show(theme),clearInterval(graphsTimerId),graphsTimerId=setInterval(()=>updateGraphs(input,debouncedFunc),graphRefreshInterval),(images=Array.from(d.querySelectorAll(".statimage"))).forEach(img=>img.classList.add("lazy"));const now=Date.now(),timeSinceLast=now-lastRefreshTime,allLoaded=images.every(img=>img.complete);lastRefreshTime=now,(timeSinceLast<longestLoadTime||!allLoaded)&&(nextInterval=Math.max(longestLoadTime+1e3-timeSinceLast,graphRefreshInterval),clearTimeout(graphsTimerId),graphsTimerId=setTimeout(()=>updateGraphs(input,debouncedFunc),nextInterval));var nextInterval=images.filter(img=>!img.classList.contains("lazyhide")),images=images.filter(img=>img.classList.contains("lazyhide")),start=Date.now();try{await Promise.all(nextInterval.map(img=>new Promise((res,rej)=>{const src=img.src.replace(/time=\d+/,"time="+now);var pre=new Image;pre.onload=()=>{img.src=src,res()},pre.onerror=rej,pre.src=src})))}catch{}debouncedFunc?.(),progressx.hide(),longestLoadTime=Math.max(longestLoadTime,Date.now()-start),await new Promise(res=>setTimeout(res,5e3));try{await Promise.all(images.map(async img=>{var src=img.src.replace(/time=\d+/,"time="+Date.now());(await fetch(src)).ok&&(img.src=src)}))}catch(error){}}}function toggleView(){var hidden,toggle=$("toggleSettings");toggle&&(hidden=!toggle.checked,form.hidden=hidden,toggle.checked=!hidden,h3.classList.toggle("visible",!hidden),hidden||($("gwidth")?.focus(),sb&&sb.scrollHeight<d.body.scrollHeight&&setTimeout(()=>window.scrollTo({top:d.body.scrollHeight,behavior:"smooth"}),500)))}function isDown(){[...d.querySelectorAll(".statimage")].length||(allgraphs.innerHTML="<span id=nographs><b>No connection to Router</b></span>",progressx.hide()),setTimeout(ensureDimensions,5e3)}"undefined"!=typeof graphRefreshInterval&&0<graphRefreshInterval&&updateGraphs();const stopRefresh=()=>clearInterval(graphsTimerId);d.addEventListener("DOMContentLoaded",()=>{d.body.classList.contains("loaded")||d.body.classList.contains("ready")||d.body.classList.add("loaded","ready");const searchInput=function(){var container=query("h1.perf");if(!container)return{};var searchContainer=d.createElement("div");searchContainer.id="graphFilter";const searchInput=d.createElement("input");searchInput.type="text",searchInput.id="searchInput";var clearButton=d.createElement("button");return clearButton.textContent="Clear Filter",clearButton.addEventListener("click",()=>{searchInput.value="",searchInput.dispatchEvent(new Event("input")),localStorage.removeItem("graphsFilter")}),searchContainer.append(searchInput,clearButton),container.insertBefore(searchContainer,container.firstChild),{searchInput:searchInput,clearButton:clearButton}}().searchInput;if(searchInput){searchInput.value=localStorage.getItem("graphsFilter")||"",applyFilter(searchInput);const debouncedApplyFilter=function(func,input){let timeoutId;return()=>{clearTimeout(timeoutId),timeoutId=setTimeout(()=>func(input),100)}}(applyFilter,searchInput);var link;searchInput.addEventListener("input",()=>{var val=searchInput.value.trim();localStorage.setItem("graphsFilter",val),val&&applyFilter(searchInput),initializeObservers(allgraphs,debouncedApplyFilter,searchInput)}),initializeObservers(allgraphs,debouncedApplyFilter,searchInput),ensureDimensions(),onVisible(allgraphs,()=>{updateGraphs(searchInput,debouncedApplyFilter),debouncedApplyFilter()}),onHidden(allgraphs,stopRefresh),query("#graphToggleCss")||((link=d.createElement("link")).rel="stylesheet",link.href="/themes/console/graphConfig.css",link.id="graphToggleCss",d.head.appendChild(link)),toggleView(),$("graphConfigs").removeAttribute("hidden"),$("toggleSettings")?.addEventListener("click",toggleView),setTimeout(isDown,6e4)}})})();