import{lsDebug}from"/js/lsDebug.js";import{onVisible,onHidden}from"/js/onVisible.js";import{searchLS}from"/js/searchLS.js";const isSingleLS=null!==document.getElementById("singleLS");document.addEventListener("DOMContentLoaded",()=>{let container=document.querySelector(".leasesets_container"),refreshInterval=null,isRefreshing=!1,lsCount=0;const debug=document.getElementById("leasesetdebug");function compact(){container&&!document.getElementById("leasesetdebug")&&document.querySelectorAll("table.leaseset").forEach(table=>{const expiry=table.querySelector(".expiry");var ekeys=Array.from(table.querySelectorAll(".ekey"));expiry&&0<ekeys.length&&(ekeys.forEach(el=>el.remove()),ekeys.forEach(ekey=>expiry.insertAdjacentElement("afterend",ekey)),ekeys=table.querySelector("tr.ekeys"))&&ekeys.remove()})}function countTypes(){var summary=document.getElementById("leasesetsummary")||document.getElementById("leasesetdebug");if(summary){const signatureCounts={},encryptionCounts=(document.querySelectorAll("span.nowrap.stype").forEach(span=>{span.classList.contains("bullet")||(span=span.querySelector("b")?.nextElementSibling)&&(span=span.textContent.trim().split(/\s+/)[0],signatureCounts[span]=(signatureCounts[span]||0)+1)}),{});document.querySelectorAll("span.nowrap.ekey").forEach(span=>{span.classList.contains("bullet")||(span=span.querySelector("b")?.nextElementSibling)&&(span=span.textContent.trim().split(/\s+/)[0],encryptionCounts[span]=(encryptionCounts[span]||0)+1)});var tbody=summary.querySelector("tbody")||summary,existingRow=tbody.querySelector("#sigEncCount"),sigCell=(existingRow&&existingRow.remove(),(existingRow=document.createElement("tr")).id="sigEncCount",document.createElement("td")),sigText=(sigCell.innerHTML=`<b>${translate_sigTypes}</b>`,Object.entries(signatureCounts).sort().map(([type,count])=>`<span class=counterLS><span class="lsLabel sigType" title="${translate_sigType}">${type} <span class=lsCounter>${count}</span></span></span>`).join(" &nbsp;")),sigValueCell=document.createElement("td"),encText=(sigValueCell.innerHTML=sigText,(sigText=document.createElement("td")).innerHTML=`<b>${translate_encTypes}</b>`,Object.entries(encryptionCounts).sort().map(([type,count])=>`<span class=counterLS><span class="lsLabel encType"  title="${translate_encType}">${type} <span class=lsCounter>${count}</span></span></span>`).join(" &nbsp;")),encValueCell=document.createElement("td");encValueCell.innerHTML=encText,debug?(existingRow.appendChild(sigCell),existingRow.appendChild(sigValueCell),existingRow.appendChild(sigText),existingRow.appendChild(encValueCell)):((encText=document.createElement("td")).colSpan=4,encText.style.textAlign="center",encText.innerHTML=`
        ${sigValueCell.innerHTML}
        <span class=vsep></span>
        &nbsp;${encValueCell.innerHTML}
      `,existingRow.appendChild(encText)),tbody.appendChild(existingRow),(sigCell=document.getElementById("lsLocalCount"))&&(sigText=document.getElementById("leasesetCounts"))&&0<(sigValueCell=sigText.querySelectorAll(".lsCounter.sets")).length&&(encValueCell=Array.from(sigValueCell).reduce((sum,el)=>(el=parseInt(el.textContent))?sum+el:sum,0),sigCell.textContent=encValueCell),summary.removeAttribute("hidden")}}function styleLabels(){var style=document.createElement("style");style.type="text/css",style.id="lsLabels",style.textContent=`
      .counterLS{padding:2px;display:inline-block;vertical-align:middle;border:var(--border_soft);box-shadow:var(--highlight);background:var(--badge)}
      .counterLS .published{background:var(--globe) no-repeat 4px center/14px}
      .counterLS .unpublished{background:var(--hardhat) no-repeat 4px center/14px}
      .counterLS .clientB32{background:var(--ping) no-repeat 4px center/14px}
      .counterLS .clientHostname{background:var(--link) no-repeat 4px center/14px}
      .lsCounter,.lsBadge{margin:-3px -1px -3px 0;padding:2px 6px;min-width:28px;display:inline-block;text-align:center;font-weight:700}
      .lsLabel{padding:1px 4px 1px 22px;display:inline-block;font-weight:500}
      .lsLabel.encType,.lsLabel.sigType{margin-right:-4px}
      .lsLabel.encType .lsCounter,.lsLabel.sigType .lsCounter{margin-left:4px}
      .lsLabel.encType{background:var(--crypto) no-repeat 4px center/14px}
      .lsLabel.sigType{background:var(--lock) no-repeat 4px center/14px}`,document.head.appendChild(style)}function sortLeasesets(){document.querySelectorAll("table.leaseset").forEach(table=>{var span,lastTh=table.querySelector("th:last-child");let sortPriority=4,sortText="";lastTh&&(sortText=lastTh.textContent.trim().toLowerCase(),(span=lastTh.querySelector("span.lsdest"))?sortPriority=span.classList.contains("published")?0:1:(span=lastTh.querySelector("a"))&&(sortPriority=span.classList.contains("destlink")?2:3)),table.dataset.sortPriority=sortPriority,table.dataset.sortText=sortText});var publishedCount,unpublishedCount,knownClientCount,clientCount,existingRow,cell,tables=Array.from(document.querySelectorAll("table.leaseset"));tables.sort((a,b)=>{var prioA=parseInt(a.dataset.sortPriority),prioB=parseInt(b.dataset.sortPriority);return prioA!==prioB?prioA-prioB:a.dataset.sortText.localeCompare(b.dataset.sortText)}),tables.forEach(table=>{table.parentNode&&table.parentNode.appendChild(table)}),window.location.search.includes("l=3")&&(tables=document.getElementById("leasesetsummary"),publishedCount=document.querySelectorAll("table.leaseset th:last-child span.lsdest.published").length,unpublishedCount=document.querySelectorAll("table.leaseset th:last-child span.lsdest:not(.published)").length,knownClientCount=document.querySelectorAll("table.leaseset th:last-child a.destlink").length,clientCount=document.querySelectorAll("table.leaseset th:last-child a:not(.destlink)").length,tables)&&((existingRow=(tables=tables.querySelector("tbody")||tables).querySelector("#leasesetCounts"))&&existingRow.remove(),(existingRow=document.createElement("tr")).id="leasesetCounts",cell=document.createElement("td"),document.createElement("td"),cell.colSpan=4,cell.style.textAlign="center",cell.innerHTML=`
          <span class=counterLS title="${translate_localPublic}"><span class="lsLabel published">Published</span> <span class="lsCounter sets">${publishedCount}</span></span> &nbsp;
          <span class=counterLS title="${translate_localPrivate}"><span class="lsLabel unpublished">Unpublished</span> <span class="lsCounter sets">${unpublishedCount}</span></span> &nbsp;
          <span class=counterLS title="${translate_requestedLS}"><span class="lsLabel clientHostname">Client (hostname)</span> <span class="lsCounter sets">${knownClientCount}</span></span> &nbsp;
          <span class=counterLS title="${translate_requestedLS}"><span class="lsLabel clientB32">Client (b32)</span> <span class="lsCounter sets">${clientCount}</span></span>
        `,existingRow.appendChild(cell),tables.appendChild(existingRow),lsCount=Array.from(document.querySelectorAll("#leasesetCounts span.lsCounter")).reduce((sum,el)=>sum+parseInt(el.textContent)||0,0),lsLocalCount.textContent=lsCount)}function refreshLeasesets(){var url;container&&(progressx.show(theme),progressx.progress(.7),url=window.location.href,fetch(url).then(response=>{if(response.ok)return progressx.progress(.8),response.text();throw new Error("Network response was not ok")}).then(html=>{var lsLabels=document.getElementById("lsLabels"),temp=document.createElement("div");temp.innerHTML=html,(html=temp.querySelector(".leasesets_container"))&&(temp=document.querySelector(".leasesets_container"))&&(temp.parentNode.replaceChild(html,temp),container=html,progressx.progress(.9),compact(),lsDebug(),countTypes(),lsLabels||styleLabels(),debug||sortLeasesets(),isSingleLS&&searchLS(),progressx.progress(1),setTimeout(()=>{progressx.hide()},100))}).catch(()=>{}))}function initLSCompact(){isRefreshing||(isRefreshing=!0,refreshInterval=setInterval(()=>{requestAnimationFrame(refreshLeasesets)},15e3)),progressx.show(theme),compact(),lsDebug(),countTypes(),styleLabels(),debug||sortLeasesets(),isSingleLS&&searchLS(),progressx.hide()}initLSCompact(),document.addEventListener("visibilitychange",()=>{"hidden"===document.visibilityState?isRefreshing&&(isRefreshing=!1,clearInterval(refreshInterval),refreshInterval=null,progressx.hide()):initLSCompact()})});