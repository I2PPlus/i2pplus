import morphdom from"/js/morphdom.js";let refreshIntervalId=null,isRefreshing=!1,currentTargetSelector=null,currentUrl=null;const fetchWorker=new SharedWorker("/js/fetchWorker.js");function refreshElements(targetSelectors,url,delay){let selectors=[];function refresh(){"visible"!==document.visibilityState||isRefreshing||(isRefreshing=!0,progressx?.show(theme),fetchWorker.port.postMessage({url:currentUrl}),setTimeout(()=>{progressx?.hide(),isRefreshing=!1},1e3))}function handleVisibilityChange(){"visible"===document.visibilityState?(refresh(),refreshIntervalId=refreshIntervalId||setInterval(refresh,delay)):(clearInterval(refreshIntervalId),refreshIntervalId=null,isRefreshing=!1)}"string"==typeof targetSelectors?selectors=targetSelectors.split(",").map(s=>s.trim()):Array.isArray(targetSelectors)&&(selectors=targetSelectors.map(s=>s.trim())),currentTargetSelector=selectors,currentUrl=url,refreshIntervalId&&clearInterval(refreshIntervalId),"visible"===document.visibilityState&&(refresh(),refreshIntervalId=setInterval(refresh,delay)),document.removeEventListener("visibilitychange",handleVisibilityChange),document.addEventListener("visibilitychange",handleVisibilityChange)}fetchWorker.port.start(),fetchWorker.port.onmessage=function(e){if((e=e.data.responseText)&&currentUrl){const doc=(new DOMParser).parseFromString(e,"text/html");requestAnimationFrame(()=>{currentTargetSelector.forEach(selector=>{var targetElements=document.querySelectorAll(selector);const targetElementsResponse=doc.querySelectorAll(selector);targetElements.forEach((targetElement,index)=>{index=targetElementsResponse[index],targetElement&&index&&morphdom(targetElement,index,{onBeforeElUpdated:(fromEl,toEl)=>!fromEl.isEqualNode(toEl)})})}),document.dispatchEvent(new Event("refreshComplete")),document.dispatchEvent(new CustomEvent("elementsRefreshed",{detail:{selectors:currentTargetSelector}}))})}};export{refreshElements};