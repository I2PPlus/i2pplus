import{onVisible,onHidden}from"/js/onVisible.js";import morphdom from"/js/morphdom.js";function start(){var $=id=>document.getElementById(id);const els={mainLogs:$("logs"),criticallogs:$("criticallogs"),errorCount:$("errorCount"),routerlogs:$("routerlogs"),routerlogsList:$("routerlogs")?.querySelector("td ul"),routerlogsFileInfo:$("routerlogs")?.querySelector("tr:first-child td p"),servicelogs:$("wrapperlogs"),refreshSpan:$("refreshPeriod"),refreshInput:$("logRefreshInterval"),toggleRefresh:$("toggleRefresh"),filterInput:$("logFilterInput")},state={updates:[],worker:new SharedWorker("/js/fetchWorker.js"),logsRefreshId:null,intervalValue:localStorage.getItem("logsRefresh")||"30"};function initRefresh(){els.mainLogs&&els.routerlogs?(stopRefresh(),state.logsRefreshId=setInterval(()=>refreshLogs(state,els),1e3*state.intervalValue),els.toggleRefresh.classList.add("enabled")):setTimeout(initRefresh,500)}function stopRefresh(){clearInterval(state.logsRefreshId)}function refreshLogs(state,els){!document.hidden&&navigator.onLine&&(progressx.show(theme),state.worker.port.postMessage({url:"/logs"}),updateInterval(state,els),addFilterInput(els),progressx.hide())}function updateInterval(state,els){state.intervalValue=localStorage.getItem("logsRefresh")||"30",els.refreshInput&&(els.refreshInput.min=0,els.refreshInput.max=3600,els.refreshInput.value=state.intervalValue),els.refreshInput&&!els.refreshSpan.classList.contains("listening")&&els.refreshInput.addEventListener("input",()=>{els.refreshSpan.classList.add("listening");var value=els.refreshInput.value;value&&!isNaN(value)&&(state.intervalValue=value,localStorage.setItem("logsRefresh",value),clearInterval(state.logsRefreshId),"0"===value?els.toggleRefresh.classList.replace("enabled","disabled"):(state.logsRefreshId=setInterval(()=>refreshLogs(state,els),1e3*value),els.toggleRefresh.classList.replace("disabled","enabled")))})}function addFilterInput(els){els.routerlogs&&!els.filterInput._listenerAdded&&(els.filterInput.addEventListener("input",(()=>{let timeout;return(...args)=>{clearTimeout(timeout),timeout=setTimeout(()=>([...args],applyFilter(els)),300)}})()),els.filterInput._listenerAdded=!0)}function applyFilter(els){const filterValue=els.filterInput.value.toLowerCase();els.routerlogsList&&els.routerlogsList.querySelectorAll("li").forEach(li=>{li.style.display=li.textContent.toLowerCase().includes(filterValue)?"":"none"})}"SharedWorker"in window&&(state.worker.port.onmessage=event=>{var{responseText:event,isDown}=event.data;isDown||(function(doc,els,state){if(els.errorCount){const newEl=doc.getElementById("errorCount");newEl&&state.updates.push(()=>morphdom(els.errorCount,newEl,{childrenOnly:!0}))}if(els.criticallogs){const newEl=doc.getElementById("criticallogs");newEl&&state.updates.push(()=>morphdom(els.criticallogs,newEl,{childrenOnly:!0}))}if(els.routerlogsList){const newFileInfo=doc.querySelector("#routerlogs tr:first-child td p");var newList=doc.querySelector("#routerlogs td ul");if(newFileInfo&&state.updates.push(()=>morphdom(els.routerlogsFileInfo,newFileInfo)),newList){const clone=newList.cloneNode(!0);if((newList=(newList=clone)&&newList.querySelector("li"))&&(shortKey=Date.now().toString().slice(-4),newList.setAttribute("data-key","log-"+shortKey)),newList=clone){const isValidPort=s=>{var n=+s;return 1<=n&&n<=65535&&s===String(n)},leasePattern=/(?:key\s*)?\$([a-zA-Z0-9~\-]{8})\$|#ls_([a-zA-Z0-9]{4})\b|\[([a-zA-Z0-9~\-]{8})\]/g,ipv4PortPattern=/\b((?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\b(?::(\d{1,5}))?\b/g,ipv6PortPattern=/(?:\b(?:[0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}|\b(?:[0-9a-fA-F]{1,4}:){1,7}:)(?::(\d{1,5}))?\b/gi;for(var node,walker=document.createTreeWalker(newList,NodeFilter.SHOW_TEXT,{acceptNode(node){return"A"===node.parentElement?.tagName?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT}},!1),textNodes=[];node=walker.nextNode();)textNodes.push(node);textNodes.forEach(textNode=>{const parent=textNode.parentElement;if(parent){const text=textNode.textContent;var fragments=[];let cursor=0;const matches=[];var addMatches=(pattern,getMatches)=>{for(pattern.lastIndex=0;null!==(match=pattern.exec(text));){var match=getMatches(match);match&&matches.push(...match)}};if(addMatches(/floodfill\s*\[([a-zA-Z0-9~\-]{6})\]/gi,m=>[{start:m.index,end:m.index+m[0].length,clean:{id:m[1],href:"/netdb?r="+m[1],isFF:!0}}]),addMatches(/router\s*\[([a-zA-Z0-9~\-]{6})\]/gi,m=>[{start:m.index,end:m.index+m[0].length,clean:{id:m[1],href:"/netdb?r="+m[1],isFF:!1}}]),addMatches(/\[([a-zA-Z0-9~\-]{6})\]/g,m=>[{start:m.index,end:m.index+m[0].length,clean:{id:m[1],href:"/netdb?r="+m[1],isFF:!1}}]),addMatches(leasePattern,m=>{var id=m[1]||m[2]||m[3];return id?[{start:m.index,end:m.index+m[0].length,clean:{id:id,href:"/netdb?l=3#"+id.substring(0,4)}}]:[]}),addMatches(ipv4PortPattern,m=>{var ipStart=m.index,full=m[0],colonIdx=full.indexOf(":"),ipEnd=ipStart+(full=-1===colonIdx?full:full.substring(0,colonIdx)).length,ipStart=[{start:ipStart,end:ipEnd,clean:{id:full,href:"/netdb?ip="+full}}];return-1!==colonIdx&&(full=m[2])&&isValidPort(full)&&ipStart.push({start:colonIdx=ipEnd+1,end:colonIdx+full.length,clean:{id:full,href:"/netdb?port="+full}}),ipStart}),addMatches(ipv6PortPattern,m=>{var full=m[0],ipStart=m.index,ipEnd=(m=m[2])?ipStart+(full.length-m.length-1):ipStart+full.length,cleanIP=(full=full.substring(0,ipEnd-ipStart)).split("%")[0],ipStart=[{start:ipStart,end:ipEnd,clean:{id:full,href:"/netdb?ipv6="+cleanIP}}];return m&&isValidPort(m)&&ipStart.push({start:full=ipEnd+1,end:full+m.length,clean:{id:m,href:"/netdb?port="+m}}),ipStart}),0!==matches.length){matches.sort((a,b)=>a.start-b.start);var merged=[];for(const m of matches)(0===merged.length||m.start>=merged[merged.length-1].end)&&merged.push(m);for(const match of merged){match.start>cursor&&fragments.push(document.createTextNode(text.slice(cursor,match.start)));var link=document.createElement("a");link.href=match.clean.href,link.textContent=match.clean.id,match.clean.isFF&&link.classList.add("isFF"),fragments.push(link),cursor=match.end}cursor<text.length&&fragments.push(document.createTextNode(text.slice(cursor))),fragments.forEach(frag=>parent.insertBefore(frag,textNode)),parent.removeChild(textNode)}}})}state.updates.push(()=>morphdom(els.routerlogsList,clone,{childrenOnly:!0,getNodeKey:el=>el.nodeType===Node.ELEMENT_NODE?el.getAttribute("data-key"):null}))}}var shortKey;if(els.servicelogs){const newEl=doc.getElementById("wrapperlogs");newEl&&state.updates.push(()=>morphdom(els.servicelogs,newEl,{childrenOnly:!0}))}}((new DOMParser).parseFromString(event,"text/html"),els,state),requestAnimationFrame(()=>{state.updates.forEach(fn=>fn()),applyFilter(els),state.updates=[]}))},state.worker.port.start(),state.worker.port.postMessage({url:"/logs"})),document.addEventListener("DOMContentLoaded",()=>{onVisible(els.mainLogs,()=>requestAnimationFrame(()=>initRefresh())),onHidden(els.mainLogs,stopRefresh),updateInterval(state,els),addFilterInput(els),applyFilter(els),els.toggleRefresh.addEventListener("click",()=>{(els.toggleRefresh.classList.contains("enabled")?(els.toggleRefresh.classList.replace("enabled","disabled"),stopRefresh):(els.toggleRefresh.classList.replace("disabled","enabled"),refreshLogs(state,els),initRefresh))()})})}start();