import{sectionToggler,countNewsItems}from"/js/sectionToggle.js";import{stickySidebar}from"/js/stickySidebar.js";import{newHosts}from"/js/newHosts.js";import{miniGraph}from"/js/miniGraph.js";let alwaysUpdate=new Set,autoRefreshInterval=null,autoRefreshScheduled=!1,connectionStatusTimeout,debounceTimeoutId=null,isDown=!1,isPaused=!1,isRefreshing=!1,lastRefreshTime=0,noResponse=0,refreshActive=!0,refreshTimeout=null,responseDoc=null,xhrContainer=document.getElementById("xhr");const parser=new DOMParser,sb=document.querySelector("#sidebar"),uri=location.pathname,worker=new SharedWorker("/js/fetchWorker.js"),elements={badges:[],volatileElements:[]},alwaysUpdateIds=["lsCount","sb_updateform","sb_shutdownStatus"];function updateCachedElements(){if(sb){elements.badges=Array.from(sb.querySelectorAll(".badge:not(#newHosts), #tunnelCount, #newsCount")),elements.volatileElements=Array.from(sb.querySelectorAll(".volatile:not(.badge)")),xhrContainer=document.getElementById("xhr");const existingIds=new Set(elements.badges.map(badge=>badge.id));alwaysUpdate=new Set(alwaysUpdateIds.filter(id=>existingIds.has(id)))}}function getRefreshInterval(){return null!=refresh?1e3*refresh:3e3}async function start(){isSidebarVisible(),updateCachedElements(),sectionToggler(),newHosts(),countNewsItems(),startAutoRefresh(),checkConnectionStatus(),window.addEventListener("resize",stickySidebar,{passive:!0}),stickySidebar()}function startAutoRefresh(){autoRefreshInterval=autoRefreshInterval||setInterval(()=>{!document.hidden&&navigator.onLine&&refreshActive&&!isRefreshing&&refreshSidebar()},getRefreshInterval())}function stopAutoRefresh(){autoRefreshInterval&&(clearInterval(autoRefreshInterval),autoRefreshInterval=null)}async function refreshSidebar(force=!1){if(refreshActive&&!document.hidden&&navigator.onLine)try{worker.port.postMessage({url:"/xhr1.jsp?requestURI="+uri,force:force})}catch(e){noResponse=Math.min(noResponse+1,10)}finally{checkConnectionStatus(),isRefreshing=!1}}function applySidebarUpdates(){if(xhrContainer=document.getElementById("xhr"),responseDoc&&xhrContainer){updateCachedElements();const responseElements={volatileElements:Array.from(responseDoc.querySelectorAll(".volatile:not(.badge)")),badges:Array.from(responseDoc.querySelectorAll(".badge:not(#newHosts)"))};var volatile=xhrContainer.querySelectorAll(".volatile"),volatileResponse=responseDoc.querySelectorAll(".volatile");if(volatile.length!==volatileResponse.length)return refreshAll();const updates=[];elements.volatileElements.forEach((elem,i)=>{const respElem=responseElements.volatileElements[i];respElem?elem.classList.contains("statusDown")&&elem.outerHTML!==respElem.outerHTML?updates.push(()=>{elem.outerHTML=respElem.outerHTML,refreshAll()}):elem.innerHTML!==respElem.innerHTML&&updates.push(()=>{elem.innerHTML=respElem.innerHTML}):requestAnimationFrame(checkConnectionStatus)}),elements.badges.forEach((elem,i)=>{const respElem=responseElements.badges[i];(respElem&&elem.textContent!==respElem.textContent||alwaysUpdate.has(elem.id))&&updates.push(()=>{respElem&&(elem.textContent=respElem.textContent)})}),0<updates.length&&requestAnimationFrame(()=>{updates.forEach(fn=>fn()),countNewsItems(),newHosts(),sectionToggler()}),isRefreshing=!1,noResponse=0}}function refreshAll(){var sbResponse;responseDoc?(sbResponse=responseDoc.getElementById("sb"))&&(xhrContainer=document.getElementById("xhr"))&&(xhrContainer.innerHTML=sbResponse.innerHTML,updateCachedElements(),sectionToggler(),newHosts(),countNewsItems(),isDown=!1,noResponse=0,document.body.classList.remove("isDown"),isRefreshing=!1):noResponse=Math.min(noResponse+1,10)}async function isOnline(){return navigator.onLine}async function updateConnectionStatus(){clearTimeout(connectionStatusTimeout),connectionStatusTimeout=setTimeout(async()=>{var online=await isOnline();(online=3<noResponse||!online)&&!isDown?(isDown=!0,document.body.classList.add("isDown"),refreshAll()):!online&&isDown&&(isDown=!1,noResponse=0,lastRefreshTime=0,document.body.classList.remove("isDown"),refreshSidebar(isRefreshing=!0).finally(()=>{isRefreshing=!1}))},500)}function checkConnectionStatus(){updateConnectionStatus()}function isSidebarVisible(){var target=document.getElementById("xhr");target&&new MutationObserver(()=>{document.hidden||isRefreshing||(clearTimeout(debounceTimeoutId),debounceTimeoutId=setTimeout(()=>{refreshSidebar(isRefreshing=!0).finally(()=>{isRefreshing=!1})},getRefreshInterval()))}).observe(target,{childList:!0,subtree:!0})}function handleStatus(){document.hidden||isRefreshing||refreshSidebar(isRefreshing=!0).finally(()=>{isRefreshing=!1})}function initSidebar(){const interval=setInterval(()=>{xhrContainer&&(clearInterval(interval),start())},5)}worker.port.start(),worker.port.addEventListener("message",({data})=>{try{var responseText=data.responseText;responseText?(noResponse=0,responseText.includes("<body id=sb>")&&(responseDoc=parser.parseFromString(responseText,"text/html"),requestAnimationFrame(applySidebarUpdates))):noResponse=Math.min(noResponse+1,10)}catch{noResponse=Math.min(noResponse+1,10)}checkConnectionStatus()}),window.addEventListener("online",updateConnectionStatus),window.addEventListener("offline",updateConnectionStatus),setInterval(updateConnectionStatus,15e3),window.addEventListener("message",event=>{event.origin!==window.location.origin||"iframeLoaded"!==event.data||isRefreshing||(startAutoRefresh(),isRefreshing=!0)}),initSidebar(),window.addEventListener("online",handleStatus),window.addEventListener("offline",checkConnectionStatus),document.addEventListener("visibilitychange",handleStatus);export{refreshSidebar};