const advConfigInit=()=>{const d=document,query=(Element.prototype.query=function(selector){return this.querySelector(selector)},Element.prototype.queryAll=function(selector){return this.querySelectorAll(selector)},Element.prototype.hasClass=function(className){return this.classList.contains(className)},selector=>d.querySelector(selector)),{container,textarea,table,infohelp,header,advForm,saveButton,cancelButton}={container:query("td.tabletextarea"),textarea:query("textarea#advancedsettings"),table:query("#advconf"),infohelp:query("#advconf thead td.infohelp"),header:query("h3#advancedconfig"),advForm:query("#advConfigForm"),saveButton:query("#saveConfig input.accept"),cancelButton:query("#saveConfig input.cancel")};for(d.body.classList.add("js"),textarea.style.display="none",infohelp.setAttribute("colspan","3");container.parentNode.firstChild&&container.parentNode.firstChild.firstChild!==textarea;)container.parentNode.removeChild(container.parentNode.firstChild);const configItems=textarea.value.split("\n").map(item=>item.split("=")).filter(parts=>2===parts.length).sort((a,b)=>a[0].localeCompare(b[0])),createRow=(key,value)=>{var row=d.createElement("tr"),keyCell=(row.className="configline",d.createElement("td")),valueCell=d.createElement("td"),delCell=d.createElement("td");return keyCell.textContent=key,valueCell.textContent=value,keyCell.setAttribute("contenteditable","true"),valueCell.setAttribute("contenteditable","true"),[keyCell,valueCell,delCell].forEach(cell=>cell.setAttribute("spellcheck","false")),[keyCell.className,valueCell.className,delCell.className]=["key","value","delete"],row.append(keyCell,valueCell,delCell),row};let lastConfigRow=null;configItems.forEach(([key,value])=>{key=createRow(key,value),(lastConfigRow=table.query("#advconf tbody tr:last-child")).insertAdjacentElement("afterend",key),lastConfigRow=key});const addNewRow=d.createElement("tr"),newKeyCell=(addNewRow.id="addNew",d.createElement("td")),newValueCell=d.createElement("td");var newDelCell=d.createElement("td");addNewRow.append(newKeyCell,newValueCell,newDelCell),[newKeyCell,newValueCell].forEach(cell=>{cell.contentEditable=!0,cell.setAttribute("spellcheck","false")}),newKeyCell.className="newKey",newValueCell.className="newValue",newDelCell.className="delete",(newDelCell=table.query(".configline"))&&newDelCell.insertAdjacentElement("beforebegin",addNewRow),new MutationObserver(mutationsList=>{mutationsList.forEach(mutation=>{mutation.addedNodes.forEach(node=>{"TD"===node.tagName&&updateTextarea()})})}).observe(table,{childList:!0,subtree:!0});const updateTextarea=()=>{const updatedItems=[];table.queryAll(".configline").forEach(row=>{var key=row.query(".key").textContent.trim(),row=row.query(".value").textContent.trim();key&&updatedItems.push(key+"="+row)}),textarea.value=updatedItems.join("\n")};table.addEventListener("click",event=>{var removedKey;(event=event.target).hasClass("delete")&&("addNew"!==(event=event.closest("tr")).id?(removedKey=event.query("td:first-child").textContent,event.remove(),updateTextarea(),table.query("thead").removeAttribute("hidden"),infohelp.id="removeKey",infohelp.innerHTML=msgKeyRemove.replace("{0}",removedKey),infohelp.scrollIntoView()):(newKeyCell.textContent="",newValueCell.textContent=""))});{let filterValue;(newDelCell=d.createElement("span")).id="advfilter";var filterInput=d.createElement("input");filterInput.type="text",filterInput.id="filterInput",newDelCell.appendChild(filterInput),filterInput.addEventListener("input",event=>{filterValue=event.target.value.toLowerCase(),table.queryAll(".configline").forEach(row=>{var key=row.query(".key").textContent.toLowerCase(),value=row.query(".value").textContent.toLowerCase();row.style.display=key.includes(filterValue)||value.includes(filterValue)?"table-row":"none"})}),(filterInput=d.createElement("button")).textContent="X",filterInput.addEventListener("click",()=>{var activeFilter=document.getElementById("filterInput"),event=(activeFilter.value="",new Event("input",{bubbles:!0}));activeFilter.dispatchEvent(event),window.scrollTo(0,0)}),newDelCell.appendChild(filterInput),header.appendChild(newDelCell)}const doSave=event=>{var modalActive=query("#modalActive");if(!modalActive){updateTextarea();const newKey=newKeyCell.textContent.trim();if(newValueCell.textContent.trim()&&!newKey)modal("No keyname provided for the submitted value.<br>Please supply a keyname."),newKeyCell.focus();else{if(newKey){if(configItems.some(item=>item[0]===newKey))return modal(`Duplicate key <b>${newKey}</b> submitted. Please modify the existing key.`),newKeyCell.textContent="",newValueCell.textContent="",(modalActive=query("#advfilter input")).value=newKey,void modalActive.dispatchEvent(new Event("input",{bubbles:!0}));(()=>{const newKey=newKeyCell.textContent.trim();configItems.some(item=>item[0]===newKey);var newValue=newValueCell.textContent.trim();newKey&&(newValue=createRow(newKey,newValue),addNewRow.insertAdjacentElement("beforebegin",newValue),newKeyCell.textContent="",newValueCell.textContent="",updateTextarea())})()}"Enter"!==event.key&&"click"!==event.type||saveButton.click()}}},resetForm=(d.addEventListener("keydown",event=>{"Enter"===event.key?(event.preventDefault(),doSave(event)):"Escape"===event.key&&(event.preventDefault(),resetForm(event))}),event=>{event.preventDefault(),textarea.value=query("input[name=nofilter_oldConfig]").value,advForm.requestSubmit(saveButton)});cancelButton.addEventListener("click",resetForm),saveButton.addEventListener("click",event=>{doSave(event)});let statusAdded=!1;!function floodfillStatus(){var info,ffstatus,h3ff=document.querySelector("#ffconf");h3ff?((info=document.createElement("span")).id="ffstatus",(ffstatus=document.querySelector("#floodfillconfig .infohelp").textContent.match(/\(.*?\)/))&&0<ffstatus.length&&(info.textContent=ffstatus[0].replace(/[\(\).]/g,""),statusAdded||(h3ff.appendChild(info),statusAdded=!0))):setTimeout(floodfillStatus,100)}()};document.addEventListener("DOMContentLoaded",advConfigInit);