import{initToggleInfo}from"/i2ptunnel/js/toggleTunnelInfo.js";const container=document.querySelector("#page"),control=document.getElementById("globalTunnelControl"),countClient=document.getElementById("countClient"),countServer=document.getElementById("countServer"),iframe=window.parent.document.querySelector(".main#tunnelmgr"),isDownElement=document.getElementById("down"),messages=document.getElementById("tunnelMessages"),notReady=document.getElementById("notReady"),tempStylesheet=document.head.querySelector("#isDownOverlay"),toggle=document.getElementById("toggleInfo"),tunnelIndex=document.getElementById("page"),url=window.location.pathname;let isDownClassAdded=!1,isDownTimeoutId;function updateElementContent(element,responseElement){responseElement&&element.innerHTML!==responseElement.innerHTML&&(element.innerHTML=responseElement.innerHTML)}async function refreshTunnelStatus(){try{var doc,response=await fetch(url,{method:"GET",headers:{"Cache-Control":"no-cache"}});response.ok?(clearTimeout(isDownTimeoutId),isDownElement&&isDownElement.remove(),tempStylesheet&&tempStylesheet.remove(),doc=(new DOMParser).parseFromString(await response.text(),"text/html"),requestAnimationFrame(()=>{resizeIframe()}),isDownClassAdded&&doc.getElementById("globalTunnelControl")&&reloadPage(),document.body.classList.remove("isDown"),container.style="",iframe.style.padding="",notReady?doc.getElementById("notReady")?refreshAll(doc):reloadPage():updateVolatile(doc),countServices(),resizeIframe(),isDownClassAdded=!1):isDownTimeoutId=setTimeout(handleDownState,5e3)}catch(error){isDownTimeoutId=setTimeout(handleDownState,5e3)}}function handleDownState(){var bg,viewportHeight=window.innerHeight;document.body.classList.contains("isDown")||document.getElementById("down")||(document.body.classList.add("isDown"),container.style.height=viewportHeight+"px",container.style.overflow="hidden",(viewportHeight=document.createElement("div")).id="down",viewportHeight.className="notReady",viewportHeight.innerHTML="<b><span>Router is down</span></b>",viewportHeight.style.position="absolute",viewportHeight.style.top="50%",viewportHeight.style.left="50%",viewportHeight.style.transform="translate(-50%, -50%)",viewportHeight.style.zIndex="9999",document.body.appendChild(viewportHeight),tempStylesheet||((viewportHeight=document.createElement("style")).id="isDownOverlay",bg="light"===theme||"classic"===theme?"#f2f2ff":"#000",viewportHeight.appendChild(document.createTextNode(".isDown::after{width:calc(100% + 16px);height:100vh;display:block;position:fixed;top:0;right:0;bottom:0;left:0;z-index:999;background:"+bg+";overflow:hidden;contain:paint;content:''}.isDown #page{display:inline-block;max-height:600px}")),document.head.appendChild(viewportHeight)),iframe&&(iframe.style.padding="0",requestAnimationFrame(()=>{resizeIframe()}))),refreshTunnelStatus(),isDownClassAdded=!0}function countServices(){const statuses=[{clientSelector:".cli.statusRunning",serverSelector:".svr.statusRunning",status:"running"},{clientSelector:".cli.statusStandby",serverSelector:".svr.statusStandby",status:"standby"},{clientSelector:".cli.statusStarting",serverSelector:".svr.statusStarting",status:"starting"},{clientSelector:".cli.statusNotRunning",serverSelector:".svr.statusNotRunning",status:"stopped"}],updateCount=(element,selector,status)=>{selector=document.querySelectorAll(selector),element.textContent=0<selector.length?" x "+selector.length:"",selector.forEach(el=>{(el=el.closest("tr"))&&((parentTr,status)=>{statuses.map(s=>s.status).forEach(s=>parentTr.classList.remove(s)),parentTr.classList.add(status)})(el,status)})};control&&statuses.forEach(({clientSelector,serverSelector,status})=>{updateCount(countClient.querySelector("."+status),clientSelector,status),updateCount(countServer.querySelector("."+status),serverSelector,status)})}function updateVolatile(responseDoc){var updating=document.querySelectorAll(".tunnelProperties .volatile");const updatingResponse=responseDoc.querySelectorAll(".tunnelProperties .volatile");updateLog(responseDoc),updating.length!==updatingResponse.length?refreshPanels(responseDoc):updating.forEach((el,i)=>{i=updatingResponse[i],el.textContent.trim()!==i.textContent.trim()&&updateElementContent(el,i)})}function updateLog(responseDoc){var messagesResponse=responseDoc?.getElementById("tunnelMessages");updateElementContent(messages,messagesResponse),messagesResponse&&!messages&&refreshAll(responseDoc)}function refreshPanels(responseDoc){updateLog(responseDoc),["serverTunnels","clientTunnels"].forEach(id=>{updateElementContent(document.getElementById(id),responseDoc.getElementById(id))})}function refreshAll(responseDoc){responseDoc=responseDoc?.getElementById("page"),updateElementContent(tunnelIndex,responseDoc),initTunnelControl(),bindToggle(),countServices(),resizeIframe()}function reloadPage(){location.reload(!0)}function bindToggle(){toggle&&!control.classList.contains("listener")&&(toggle.addEventListener("click",initToggleInfo),control.classList.add("listener"))}function refreshIndex(){refreshTunnelStatus(),control?(bindToggle(),tunnelIndex.classList.contains("listener")||initTunnelControl()):setTimeout(refreshIndex,500)}function initTunnelControl(){tunnelIndex.classList.contains("listener")||tunnelIndex.addEventListener("click",async event=>{var target=event.target;if(target.classList.contains("control")&&!target.classList.contains("create")){event.preventDefault(),event=target.href;try{var doc,response=await fetch(event,{method:"GET",headers:{"Cache-Control":"no-cache"}});response.ok&&(doc=(new DOMParser).parseFromString(await response.text(),"text/html"),countServices(),updateVolatile(doc))}catch{}await 0,tunnelIndex.classList.add("listener")}})}function resizeIframe(){!document.documentElement.classList.contains("iframed")&&window.self===window.top||setTimeout(()=>{parent.postMessage({action:"resize",iframeId:"i2ptunnelframe"},location.origin)},100)}function preloadImage(url){(new Image).src=url}toggle&&bindToggle(),control&&initTunnelControl(),setInterval(refreshIndex,5e3),document.addEventListener("DOMContentLoaded",()=>{countServices(),"dark"===theme&&preloadImage("/themes/console/dark/images/tunnelmanager.webp")}),window.addEventListener("load",function(){window.self!==window.top&&resizeIframe()});