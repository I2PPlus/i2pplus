import{isDocumentVisible}from"./refreshTorrents.js";const cachedTunnelCounts={timestamp:0,data:null};let inLabel="",outLabel="";async function fetchTunnelData(url="/configtunnels",timeout=1e4){if(isDocumentVisible){const controller=new AbortController;timeout=setTimeout(()=>controller.abort(),timeout);try{var response=await fetch(url,{signal:controller.signal});if(!response.ok)throw new Error(response.statusText);var doc=(new DOMParser).parseFromString(await response.text(),"text/html"),data={inCount:doc.querySelector("#snarkIn")?.textContent.trim(),outCount:doc.querySelector("#snarkOut")?.textContent.trim()};if(data.inCount&&data.outCount)return data}catch(error){}finally{clearTimeout(timeout)}return null}}async function getSnarkTunnelCount(interval=3e4){return cachedTunnelCounts.timestamp+interval>Date.now()||(cachedTunnelCounts.data=await fetchTunnelData(),cachedTunnelCounts.timestamp=Date.now()),cachedTunnelCounts.data}function updateTunnelCounts(result){var snarkInCount,snarkOutCount;result&&(snarkInCount=document.querySelector("#tnlInCount .badge"),snarkOutCount=document.querySelector("#tnlOutCount .badge"),snarkInCount)&&snarkOutCount&&([inLabel,outLabel]=[result.inCount,result.outCount],snarkInCount=document.head.querySelector("#tc")||createStyleTag(),snarkOutCount=`#tnlInCount .badge::after{content:"${inLabel}"}#tnlOutCount .badge::after{content:"${outLabel}"}`,snarkInCount.textContent!==snarkOutCount)&&(snarkInCount.textContent=snarkOutCount)}function createStyleTag(){var styleTag=document.createElement("style");return styleTag.id="tc",document.head.appendChild(styleTag),styleTag}document.addEventListener("DOMContentLoaded",async()=>{var result=await getSnarkTunnelCount(),refresh=null!==snarkRefreshDelay?snarkRefreshDelay-500:1e4;updateTunnelCounts(result),setInterval(async()=>{updateTunnelCounts(await getSnarkTunnelCount())},Math.max(refresh,1e4))});