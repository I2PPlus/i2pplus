import{MESSAGE_TYPES}from"./messageTypes.js";import{pageNav}from"./pageNav.js";import{showBadge}from"./filterBar.js";import{snarkSort}from"./snarkSort.js";import{toggleDebug}from"./toggleDebug.js";import{Lightbox}from"./lightbox.js";import{initSnarkAlert}from"./snarkAlert.js";const cache=new Map,cacheDuration=5e3,debugMode=document.getElementById("debugMode"),files=document.getElementById("dirInfo"),filterbar=document.getElementById("filterBar"),home=document.querySelector("#navbar .nav_main"),isIframed=document.documentElement.classList.contains("iframed")||window.parent,isStandalone=document.documentElement.classList.contains("standalone"),mainsection=document.getElementById("mainsection"),parentDoc=window.parent.document,query=window.location.search,screenlog=document.getElementById("screenlog"),snarkHead=document.getElementById("snarkHead"),storageRefresh=localStorage.getItem("snarkRefresh"),torrents=document.getElementById("torrents"),torrentsBody=document.getElementById("snarkTbody"),torrentForm=document.getElementById("torrentlist");let chimpIsCached=!1,noConnection=!1,snarkRefreshIntervalId,screenLogIntervalId,debugging=!1,initialized=!1,isDocumentVisible=!0,lastCheckTime=0,requireFullRefresh=!0;const requestAnimationFramePromise=callback=>{let requestId;const execCallback=()=>{try{callback()}catch(error){debugging&&console.error(error)}finally{cancelAnimationFrame(requestId)}};return new Promise(resolve=>{var clear=()=>{cancelAnimationFrame(requestId),resolve()};return requestId=requestAnimationFrame(execCallback),requestAnimationFramePromise.cancel||(requestAnimationFramePromise.cancel=clear),clear})};async function getRefreshInterval(){var refreshInterval=snarkRefreshDelay||parseInt(localStorage.getItem("snarkRefreshDelay"))||5;return localStorage.setItem("snarkRefresh",refreshInterval),1e3*refreshInterval}async function getURL(){return window.location.href.replace("/i2psnark/","/i2psnark/.ajax/xhr1.html")}async function setLinks(query){home&&(home.href=query?"/i2psnark/"+query:"/i2psnark/")}async function initHandlers(){torrents&&(snarkSort(),debugMode)&&toggleDebug(),setLinks(),await requestAnimationFramePromise(async()=>{document.getElementById("pagenavtop")&&await pageNav(),filterbar&&await showBadge(),debugging&&console.log("initHandlers()")})}async function updateElement(elem,respElem,property="innerHTML"){elem&&respElem&&elem[property].trim()!==(respElem=respElem[property].trim())&&(elem[property]=respElem)}const worker=new Worker("/i2psnark/.res/js/snarkWork.js"),parser=new DOMParser,container=document.createElement("div");let abortController=new AbortController;const ongoingRequests=new Map;async function fetchHTMLDocument(url,forceFetch=!1){if(cleanupCache(),!forceFetch&&ongoingRequests.has(url))return ongoingRequests.get(url);try{if(!forceFetch){var cachedDocument=cache.get(url),now=Date.now();if(cachedDocument&&now-cachedDocument.timestamp<cacheDuration)return cachedDocument.doc}const signal=abortController.signal,promise=(async()=>{var htmlString,response=await fetch(url,{signal:signal});if(response.ok)return htmlString=await response.text(),htmlString=parser.parseFromString(htmlString,"text/html"),cache.set(url,{doc:htmlString,timestamp:Date.now()}),htmlString;throw new Error(`Network error: ${response.status} `+response.statusText)})();ongoingRequests.set(url,promise);var result=await promise;return ongoingRequests.delete(url),result}catch(error){throw debugging&&"AbortError"!==error.name&&console.error(error),error}finally{abortController=new AbortController}}const staleCacheKeys=new Set;function cleanupCache(){var key,value,now=Date.now();for([key,value]of cache.entries())now-value.timestamp>=cacheDuration&&staleCacheKeys.add(key);removeStaleCacheKeys()}function removeStaleCacheKeys(){for(const key of staleCacheKeys)cache.delete(key);staleCacheKeys.clear()}async function doRefresh({url=window.location.href,forceFetch=!1}={}){var defaultUrl=await getURL();const responseDoc=await fetchHTMLDocument(url||defaultUrl,forceFetch);await requestAnimationFramePromise(async()=>refreshTorrents(responseDoc)),await initHandlers(),await showBadge()}async function refreshTorrents(callback){try{document.getElementsByClassName("completed"),document.getElementById("torrentInfoControl");var dirlist=document.getElementById("dirlist"),down=document.getElementById("NotFound")||document.getElementById("down");async function refreshAll(){try{var newMainsection,mainsectionContainer=await fetchHTMLDocument(await getURL());const newTorrentsBody=mainsectionContainer.querySelector("#snarkTbody");newTorrentsBody?await requestAnimationFramePromise(async()=>{updateElement(torrentsBody,newTorrentsBody),async function(){try{var responseDoc=await fetchHTMLDocument(await getURL()),snarkFooter=document.getElementById("snarkFoot"),snarkFooterResponse=responseDoc.querySelector("#snarkFoot"),snarkHeader=document.getElementById("snarkHead"),snarkHeaderResponse=responseDoc.querySelector("#snarkHead");if(snarkFooter&&snarkFooterResponse){var thElements=snarkFooter.querySelectorAll("th");const thElementsResponse=snarkFooterResponse.querySelectorAll("th");thElements.length===thElementsResponse.length&&thElements.forEach((th,index)=>{th.innerHTML=thElementsResponse[index].innerHTML})}if(snarkHeader&&snarkHeaderResponse){thElements=snarkHeader.querySelectorAll("th");const thElementsResponse=snarkHeaderResponse.querySelectorAll("th");thElements.length===thElementsResponse.length&&thElements.forEach((th,index)=>{th.innerHTML=thElementsResponse[index].innerHTML});var noload=torrents?.querySelector("#noTorrents");torrentsBody&&0===torrentsBody.children.length||noload?snarkHeader.querySelectorAll("th:nth-child(n+2) .sortIcon, th:nth-child(n+2) .optbox").forEach(el=>el.style.opacity="0"):torrentsBody&&torrentsBody.children.length<2?snarkHeader.querySelectorAll("th:nth-child(n+2) .sortIcon").forEach(el=>el.style.opacity="0"):snarkHeader.querySelectorAll("th:nth-child(n+2):not(.tAction) img, th:nth-child(n+2):not(.tAction) input").forEach(el=>el.style.opacity="")}}catch(error){}}(),refreshScreenLog(void 0),debugging&&console.log("refreshAll()")}):(newMainsection=mainsectionContainer.querySelector("#mainsection"),newMainSection&&await updateElement(mainsection,newMainsection))}catch(error){debugging&&console.error(error)}}localStorage.hasOwnProperty("snarkFilter"),initialized||down||(initialized=!0,window.top===parent.window.top||document.documentElement.classList.contains("iframed")||document.documentElement.classList.add("iframed"),document.getElementById("tnlInCount"))||(snarkHead.classList.add("initializing"),await new Promise(resolve=>setTimeout(()=>{snarkHead.classList.remove("initializing"),resolve()},3e3))),storageRefresh||localStorage.setItem("snarkRefresh",await getRefreshInterval()),await setLinks(query),torrents?await requestAnimationFramePromise(async()=>async function(){try{var pagenavtop,pagenavtopResponse,filterbarResponse,torrentFormResponse,responseDoc=await fetchHTMLDocument(await getURL()),updating=torrents.querySelectorAll("#snarkTbody tr, #dhtDebug .dht");const updatingResponse=[...responseDoc.querySelectorAll("#snarkTbody tr, #dhtDebug .dht")];torrents&&(filterbar&&(await updateElement(filterbar.querySelector("#filterBar .filter#all .badge"),responseDoc.querySelector("#filterBar .filter#all.enabled .badge"),"textContent"),pagenavtop=document.getElementById("pagenavtop"),pagenavtopResponse=responseDoc.querySelector("#pagenavtop"),filterbarResponse=responseDoc.querySelector("#filterBar"),filterbar&&!filterbarResponse||!pagenavtop&&pagenavtopResponse?((torrentFormResponse=responseDoc.querySelector("#torrentlist"))&&await updateElement(torrentForm,torrentFormResponse),await initHandlers()):pagenavtop&&pagenavtopResponse&&pagenavtop.outerHTML.trim()!==pagenavtopResponse.outerHTML.trim()&&(pagenavtop.outerHTML=pagenavtopResponse.outerHTML,requireFullRefresh=!0)),updatingResponse.length!==updating.length||requireFullRefresh?requireFullRefresh&&updatingResponse&&refreshAll():updating.forEach(async(currentRow,rowIndex)=>{var currentRowTds=currentRow.querySelectorAll("td");const responseRowTds=updatingResponse[rowIndex].querySelectorAll("td");currentRowTds.length===responseRowTds.length&&(currentRowTds.forEach((currentTd,tdIndex)=>{currentTd.textContent=responseRowTds[tdIndex].textContent}),currentRow.classList.toString()!==updatingResponse[rowIndex].classList.toString())&&(currentRow.classList=updatingResponse[rowIndex].classList)}))}catch(error){debugging&&console.error(error)}}()):dirlist?await requestAnimationFramePromise(async()=>async function(){try{var responseDoc=await fetchHTMLDocument(window.location.href);for(const selector of["#dirInfo tbody tr.incomplete td","#torrentInfoStats .nowrap"]){var elements=document.querySelectorAll(selector),responseElements=responseDoc.querySelectorAll(selector);if(responseElements.length===elements.length)for(let index=0;index<elements.length;index++){var element=elements[index],responseElement=responseElements[index];responseElement&&updateElement(element,responseElement)}}}catch(error){debugging&&console.error(error)}}()):down&&await requestAnimationFramePromise(async()=>refreshAll())}catch(error){}}async function refreshScreenLog(callback,forceFetch=!1){return new Promise(async resolve=>{try{var doc,expiry,screenlog=document.getElementById("messages");if(!screenlog||screenlog.hidden&&""===screenlog.textContent.trim())resolve();else{screenlog.removeAttribute("hidden");let responseDoc;if(callback||forceFetch||!cache.has("screenlog")||([doc,expiry]=cache.get("screenlog"),expiry>Date.now()?responseDoc=doc:cache.delete("screenlog")),!responseDoc||forceFetch){if(!(responseDoc=await fetchHTMLDocument("/i2psnark/.ajax/xhrscreenlog.html",forceFetch)))return void resolve();cache.set("screenlog",[responseDoc,Date.now()+3*cacheDuration])}var screenlogResponse=responseDoc.getElementById("messages");(screenlogResponse?(await updateElement(screenlog,screenlogResponse),convertEncodedSpaces(),callback&&callback(),resolve(),convertEncodedSpaces):resolve)()}}catch(error){resolve()}})}function convertEncodedSpaces(){var msgElements;function replaceEncodedSpaces(node){node.nodeType===Node.TEXT_NODE?node.nodeValue=node.nodeValue.replace(/%20/g," "):node.nodeType===Node.ELEMENT_NODE&&(node.tagName.toLowerCase(),Array.from(node.childNodes).forEach(replaceEncodedSpaces))}screenlog&&(msgElements=screenlog.querySelectorAll("li.msg"))&&msgElements.forEach(element=>replaceEncodedSpaces(element))}function refreshOnSubmit(){document.querySelectorAll("form").forEach(form=>{const iframe=document.getElementById("processForm");if(form&&iframe){const formSubmitted=new Promise(resolve=>{const loadHandler=()=>{iframe.removeEventListener("load",loadHandler),resolve()};iframe.addEventListener("load",loadHandler)});form.onsubmit=async event=>{((event=event.submitter)instanceof HTMLInputElement&&event.classList||null===event)&&(await formSubmitted,await new Promise(resolve=>setTimeout(resolve,2e3)),await refreshScreenLog(void 0,!0),convertEncodedSpaces())}}}),document.addEventListener("click",event=>{const clickTarget=event.target;clickTarget.closest("form");var stopAllOrStartAllInactive=document.querySelector('input[id^="action"]:not(.depress)'),dirlist=document.getElementById("dirlist");if(clickTarget.matches("input[type=submit]"))event.stopPropagation(),clickTarget.form.requestSubmit(),clickTarget.matches('input[id^="action"]')&&(stopAllOrStartAllInactive.classList.add("tempDisabled"),setTimeout(()=>{stopAllOrStartAll.classList.remove("tempDisabled")},4e3));else if(clickTarget.matches("#nav_main:not(.isConfig")&&!dirlist){const navMain=document.querySelector("#nav_main:not(.isConfig)");navMain.classList.add("isRefreshing"),event.preventDefault(),refreshScreenLog(refreshTorrents,!0),setTimeout(()=>{navMain.classList.remove("isRefreshing"),clickTarget.blur()},200)}})}async function initSnarkRefresh(){setInterval(checkIfUp,5e3),clearInterval(snarkRefreshIntervalId),document.documentElement.removeAttribute("style");var loaded=torrentsBody?.querySelector(".rowEven"),noload=torrents?.querySelector("#noTorrents");loaded&&noload&&noload.remove();try{snarkRefreshIntervalId=setInterval(async()=>{try{isDocumentVisible&&(await doRefresh(),await showBadge(),await refreshScreenLog(),convertEncodedSpaces())}catch(error){debugging&&console.error(error)}},await getRefreshInterval()),files&&document.getElementById("lightbox")&&(new Lightbox).load(),(document._events?.click||[]).forEach(event=>document.removeEventListener("click",event)),refreshOnSubmit()}catch(error){debugging&&console.error(error)}chimpIsCached||(isStandalone?preloadImage("/i2psnark/.res/themes/snark/midnight/images/chimp.webp"):preloadImage("/themes/snark/midnight/images/chimp.webp"),chimpIsCached=!0)}function stopSnarkRefresh(){clearInterval(snarkRefreshIntervalId)}async function checkIfUp(minDelay=14e3){var currentTime=Date.now();if(!(currentTime-lastCheckTime<minDelay)&&(lastCheckTime=currentTime,isDocumentVisible))try{var overlay=document.getElementById("offline"),offlineStylesheet=document.getElementById("offlineCss");(await fetch(window.location.href,{method:"HEAD"})).ok&&(isIframed&&parentDoc.documentElement.classList.remove("isDown"),overlay&&overlay.remove(),offlineStylesheet)&&offlineStylesheet.remove()}catch(error){debugging&&console.error(error),isIframed&&parentDoc.documentElement.classList.add("isDown"),setTimeout(isDown,3e3),await refreshTorrents()}}function preloadImage(src){const show=url=>{},loadImage=url=>show(url);async function ensureCached(u){if(!await async function(u){if("caches"in window)try{var res=await(await caches.open("my-image-cache")).match(new Request(u,{mode:"cors"}));if(res)return show(URL.createObjectURL(await res.blob())),!0}catch{}return!1}(u)){if(!("caches"in window))return loadImage(u);try{var req=new Request(u,{mode:"cors"}),res=await fetch(req,{cache:"reload"});if(!res.ok)return loadImage(u);await(await caches.open("my-image-cache")).put(req,res.clone()),show(URL.createObjectURL(await res.blob()))}catch{loadImage(u)}}}ensureCached(src),setInterval(()=>ensureCached(src),6e5)}function isDown(){var offlineStyles=`:root{--chimp:url(${isStandalone?"/i2psnark/.res/themes/snark/midnight/images/chimp.webp":"/themes/snark/midnight/images/chimp.webp"});--spinner:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'%3E%3Cg%3E%3Cpath d='M78.75 16.18V1.56a64.1 64.1 0 0 1 47.7 47.7H111.8a49.98 49.98 0 0 0-33.07-33.08zM16.43 49.25H1.8a64.1 64.1 0 0 1 47.7-47.7V16.2a49.98 49.98 0 0 0-33.07 33.07zm33.07 62.32v14.62A64.1 64.1 0 0 1 1.8 78.5h14.63a49.98 49.98 0 0 0 33.07 33.07zm62.32-33.07h14.62a64.1 64.1 0 0 1-47.7 47.7v-14.63a49.98 49.98 0 0 0 33.08-33.07z' fill='%23dd5500bb'/%3E%3CanimateTransform attributeName='transform' type='rotate' from='0 64 64' to='-90 64 64' dur='1200ms' repeatCount='indefinite'/%3E%3C/g%3E%3C/svg%3E")}*{user-select:none}body,html,#circle,#offline{margin:0;padding:0;height:100vh;min-height:100%;position:relative;overflow:hidden}#circle,#offline{position:absolute;top:0;left:0;bottom:0;right:0}#offline{z-index:99999999;background:#000d;backdrop-filter:blur(2px)}#circle::before{content:"";width:230px;height:230px;border-radius:50%;border:28px solid #303;box-shadow:0 0 0 8px #000,0 0 0 8px #000 inset;display:block;position:absolute;top:calc(50% - 132px);left:calc(50% - 135px);background:radial-gradient(circle at center,rgba(0,0,0,0),70%,#313 75%),var(--spinner) no-repeat center center/240px,var(--chimp) no-repeat calc(50% + 5px) calc(50% + 10px)/250px,#000;transform:scale(.8);will-change:transform}`,offlineCss=document.createElement("style"),offlineStyles=(offlineCss.id="offlineCss",offlineCss.textContent=offlineStyles,document.createElement("div")),spinner=document.createElement("div");offlineStyles.id="offline",spinner.id="circle",offlineStyles.appendChild(spinner),document.getElementById("offline")||(document.head.appendChild(offlineCss),document.body.appendChild(offlineStyles)),isIframed&&parentDoc.documentElement.classList.add("isDown")}document.addEventListener("visibilitychange",()=>{((isDocumentVisible=!document.hidden)?initSnarkRefresh:stopSnarkRefresh)()}),document.addEventListener("DOMContentLoaded",()=>{convertEncodedSpaces(),document.body.removeAttribute("style")});export{doRefresh,getURL,initSnarkRefresh,refreshScreenLog,refreshTorrents,snarkRefreshIntervalId,isDocumentVisible};