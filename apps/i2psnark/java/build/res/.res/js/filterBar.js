import{refreshTorrents,doRefresh}from"./refreshTorrents.js";const torrents=document.getElementById("torrents");let filterbar,observer,snarkCount;async function showBadge(){var filterbar=document.getElementById("filterBar");if(filterbar){var filterQuery=(urlParams=new URLSearchParams(window.location.search)).get("filter"),urlParams=null!==urlParams.get("search")?"search":filterQuery||"all",filterQuery=filterbar.querySelectorAll(".filter");const activeFilter=document.getElementById(urlParams),activeBadge=activeFilter.querySelector(".badge");activeBadge.id="filtercount","all"===activeFilter.id?(activeBadge.hidden=!1,filterbar.querySelector(".filter#all .badge")):activeBadge.hidden=!0,filterQuery.forEach(filter=>{filter!==activeFilter?(filter.classList.remove("enabled"),Object.assign(filter,{pointerEvents:"none",opacity:".5"}),filter.style.pointerEvents="none",filter.style.opacity=".5",filter.querySelectorAll(".badge").forEach(badge=>{badge.closest(".filter#all")?Object.assign(badge,{hidden:!0,id:""}):filter&&"all"!==filter.id&&Object.assign(badge,{hidden:!0,textContent:"",id:""})})):(observer&&observer.disconnect(),(observer=new MutationObserver(()=>{"all"!==activeFilter.id&&(snarkCount=countSnarks(),activeBadge.textContent=snarkCount),activeBadge.hidden=!1})).observe(torrents,{childList:!0,subtree:!0})),filter!==activeFilter&&setTimeout(()=>{filter.style.pointerEvents="",filter.style.opacity=""},1e3)}),activeFilter&&!activeFilter.classList.contains("enabled")&&(activeFilter.classList.add("enabled"),window.localStorage.setItem("snarkFilter",activeFilter.id))}}function countSnarks(){return torrents?.querySelectorAll("#snarkTbody tr.volatile:not(.peerinfo)").length}function updateURLs(){document.getElementById("torrentlist")&&(window.location.search,document.getElementById("noload"),document.querySelectorAll(".sorter").forEach(item=>{item.addEventListener("click",()=>{var params;(params=window.location.search)&&window.localStorage.setItem("queryString",params)})}))}async function filterNav(){var filterbar=document.getElementById("filterBar");if(filterbar){const pagenavtop=document.getElementById("pagenavtop");filterbar.addEventListener("click",async function(event){var filterElement=event.target.closest(".filter");if(filterElement){event.preventDefault(),filterElement.classList.contains("enabled")||filterElement.classList.add("enabled");var xhrURL="/i2psnark/.ajax/xhr1.html"+(event=new URL(filterElement.href)).search;history.replaceState({},"",event),showBadge();try{await doRefresh(xhrURL,!0)}catch{}pagenavtop&&(pagenavtop.hidden="all"!==filterElement.id)}})}else setTimeout(filterNav,1500)}document.addEventListener("DOMContentLoaded",function(){updateURLs(),filterNav(),countSnarks(),showBadge()});export{updateURLs,showBadge};