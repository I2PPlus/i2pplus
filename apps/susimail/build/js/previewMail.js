function previewMail(){const PREVIEW_HIDE_DELAY_MS=250,previewCache=new Map;let hoverTimer=null,hideTimer=null,popup=null,currentPreviewUrl;function cleanText(raw){return raw?(raw=(raw=(raw=(raw=(raw=raw.replace(/Having[\s\u00A0\u2000-\u200B\u3000]+problems[\s\u00A0\u2000-\u200B\u3000]+viewing[\s\u00A0\u2000-\u200B\u3000]+this[\s\u00A0\u2000-\u200B\u3000]+email\?View[\s\u00A0\u2000-\u200B\u3000]+email[\s\u00A0\u2000-\u200B\u3000]+online/gi,"")).replace(/[\s\u00A0\u2000-\u200B\u3000]+/g," ")).replace(/,(?=\S)/g,", ")).replace(/<([a-zA-Z][\w-]*)[^>]*>(.*?)<\/\1>/gi,"$2")).replace(/<([a-zA-Z][\w-]*)\b[^>]*\/>/g,"")).trim():""}function ensurePopup(){if(!popup){var htmlTag=document.documentElement;(popup=document.createElement("div")).id="mail-preview-popup";let popupBg="#000",popupBorder="#555";(window.theme&&["light","classic"].includes(window.theme)||htmlTag.classList.contains("light")||htmlTag.classList.contains("classic"))&&(popupBg="#f2f2f2",popupBorder="2px solid #bbc"),Object.assign(popup.style,{padding:"10px 16px",maxWidth:"70%",minWidth:"480px",display:"none",position:"absolute",zIndex:"9999",wordBreak:"break-word",border:popupBorder,borderRadius:"2px",background:popupBg,boxShadow:"0 2px 10px rgba(0,0,0,0.3)"}),(htmlTag=document.createElement("div")).className="mail-preview-content",htmlTag.textContent="Loading…",Object.assign(htmlTag.style,{padding:"4px 8px",maxHeight:"300px",display:"inline-block",overflow:"auto"}),popup.appendChild(htmlTag),document.body.appendChild(popup),popup.addEventListener("mouseenter",()=>{clearTimeout(hideTimer)}),popup.addEventListener("mouseleave",()=>{hideTimer=setTimeout(()=>hidePopup(),PREVIEW_HIDE_DELAY_MS)})}return popup}function hidePopup(){popup&&(popup.style.display="none")}document.documentElement.addEventListener("mouseenter",e=>{const anchor=e.target.closest(".mailListSubject a");if(anchor){const showValue=anchor.getAttribute("href");showValue&&(clearTimeout(hideTimer),clearTimeout(hoverTimer),hoverTimer=setTimeout(()=>async function(el,showValue){var content=ensurePopup().querySelector(".mail-preview-content");clearTimeout(hideTimer),clearTimeout(hoverTimer),content.textContent="Loading…",content.classList.add("fetching"),currentPreviewUrl=showValue;{var el=el.getBoundingClientRect(),popupRect=popup.getBoundingClientRect(),spaceBelow=window.innerHeight-el.bottom,spaceAbove=el.top;let top,left=(top=!(spaceBelow>=popupRect.height+16)&&spaceAbove>=popupRect.height+16?window.scrollY+el.top-popupRect.height-8:window.scrollY+el.bottom+8,window.scrollX+el.left);left+popupRect.width>window.innerWidth&&(left=window.scrollX+Math.max(0,window.innerWidth-popupRect.width-16)),popup.style.top=top+"px",popup.style.left=left+"px"}popup.style.display="block",spaceBelow=await async function fetchPreview(showValue,depth=0){var cacheKey=depth+":"+showValue;if(previewCache.has(cacheKey)){var cached=previewCache.get(cacheKey);if("string"==typeof cached)return cached;if(cached instanceof Promise)try{return await cached||""}catch{return previewCache.delete(cacheKey),""}}cached=async function(showValue,depth=0){if(1<depth)return"";const controller=new AbortController,timeoutId=setTimeout(()=>controller.abort(),3e3);let response;try{response=await fetch(showValue,{credentials:"same-origin",headers:{Accept:"text/html"},signal:controller.signal})}catch(e){return clearTimeout(timeoutId),"AbortError"===e.name?"Could not preview mail (not downloaded?)":"Network error loading preview."}if(clearTimeout(timeoutId),!response.ok)return"";if((showValue=(response.headers.get("content-type")||"").toLowerCase()).includes("image/")||showValue.includes("application/pdf")||showValue.includes("application/zip")||showValue.includes("application/x-rar-compressed")||showValue.includes("application/x-7z-compressed")||showValue.includes("application/octet-stream")||showValue.includes("application/msword")||showValue.includes("application/vnd.openxmlformats-officedocument"))return`Binary file attachment detected: ${showValue.split(";")[0]}.`;if((showValue=response.headers.get("content-length"))&&3e5<parseInt(showValue,10))return"Preview skipped: message too large.";let text;try{text=await response.text()}catch(e){return"Failed to read message content."}if(0===text.length)return"";if(3e5<text.length)return"Preview skipped: message too large.";await new Promise(resolve=>setTimeout(resolve,0));var showValue=(new DOMParser).parseFromString(text,"text/html"),mailbodyParagraphs=Array.from(showValue.querySelectorAll("p.mailbody")).map(p=>p.textContent.trim()).filter(t=>0<t.length);return 0<mailbodyParagraphs.length?cleanText(mailbodyParagraphs.join("\n\n")):(mailbodyParagraphs=showValue.querySelector('iframe[src*="?att="][src*="msg="]'))?.src?fetchPreview(new URL(mailbodyParagraphs.src,window.location.origin).href,depth+1):(mailbodyParagraphs=showValue.querySelector('a[href*="?att="][href*="msg="]'))?.href?fetchPreview(new URL(mailbodyParagraphs.href,window.location.origin).href,depth+1):cleanText(showValue.body?.textContent||"")||""}(showValue,depth),previewCache.set(cacheKey,cached);try{var result=await cached;return previewCache.set(cacheKey,result),result}catch(err){return previewCache.delete(cacheKey),""}}(showValue),currentPreviewUrl===showValue&&(content.textContent=spaceBelow||"No preview available",content.classList.remove("fetching"))}(anchor,showValue),150))}},!0),document.documentElement.addEventListener("mouseleave",e=>{e.target.closest(".mailListSubject a")&&(clearTimeout(hoverTimer),hideTimer=setTimeout(()=>hidePopup(),PREVIEW_HIDE_DELAY_MS))},!0),ensurePopup()}document.addEventListener("DOMContentLoaded",previewMail);